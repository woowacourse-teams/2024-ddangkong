name: FE Review Reminder for Discord

on:
  pull_request:
    branches:
      - develop
  schedule:
    - cron: '10 1 * * 1-5' # ë§¤ì£¼ ì›”ìš”ì¼ë¶€í„° ê¸ˆìš”ì¼ê¹Œì§€, í•œêµ­ ì‹œê°„ ì˜¤ì „ 10ì‹œ 10ë¶„ì— ì‹¤í–‰
  workflow_dispatch:

jobs:
  review-reminder:
    runs-on: ubuntu-latest

    steps:
      - name: Send Reminder to Discord
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.FE_REVIEW_NOTIFICATION_WEBHOOK_URL }}
          DISCORD_MENTION: ${{ secrets.FE_GITHUB_DISCORD_ID }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // GitHub ì‚¬ìš©ìëª…ê³¼ Discord ë©˜ì…˜ ì •ë³´ ë§¤í•‘
            const discordMentions = JSON.parse(process.env.DISCORD_MENTION);

            const discordNotMentions = {
              'useon': 'ì¬ë°ì´',
              'novice0840': 'í¬ë©”',
              'rbgksqkr': 'ë§ˆë£¨',
            };

            const feReviewers = ['useon', 'novice0840', 'rbgksqkr']

            async function getReviews(owner, repo, prNumber) {
              // íŠ¹ì • PRì˜ ë¦¬ë·° ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
              const reviews = await github.rest.pulls.listReviews({
                owner,
                repo,
                pull_number: prNumber,
              });
              return reviews.data;
            }

            try {
              // ì—´ë ¤ ìˆëŠ” PR ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
              const pullRequests = await github.rest.pulls.list({
                owner,
                repo,
                state: 'open',
              });

              // FE ë¼ë²¨ì´ ë‹¬ë¦° PRì„ D-DAYê°€ ì„ë°•í•œ ìˆœì„œë¡œ ì •ë ¬
              const fePrs = pullRequests.data
                .filter(pr => pr.labels.some(label => label.name.includes('FE')))
                .map(pr => {
                  const dLabel = pr.labels.find(label => label.name.startsWith('D-'));
                  const urgency = dLabel ? parseInt(dLabel.name.split('-')[1], 10) : Number.MAX_SAFE_INTEGER;
                  return {
                    ...pr,
                    urgency,
                    dLabelName: dLabel?.name || 'D-3',
                    updatedAt: pr.updated_at,
                    createdAt: pr.created_at,
                  };
                })
                .sort((a, b) => a.urgency - b.urgency);

              // ì—´ë¦° PR ì¤‘ FE PRì´ ì—†ëŠ” ê²½ìš° ì‹¤í–‰ ì¢…ë£Œ
              if (fePrs.length === 0) {
                console.log('No FE PRs to remind.');
                return;
              }

              const messages = await Promise.all(
                fePrs.map(async pr => {
                  const reviews = await getReviews(owner, repo, pr.number);
                  const requestedReviewers = feReviewers.filter((reviewer) => reviewer !== pr.user.login) // PR ì‘ì„±ì ì œì™¸

                  // ë¦¬ë·° ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” Map ê°ì²´ ìƒì„±
                  const reviewStates = new Map();
                  reviews.forEach(review => {
                    const reviewer = review.user.login;
                    const state = review.state;
                    if (reviewer !== pr.user.login) { // PR ì‘ì„±ìëŠ” ì œì™¸
                      reviewStates.set(reviewer, state);
                    }
                  });

                  // ë¦¬ë·° ìƒíƒœ ë©”ì‹œì§€ ìƒì„±
                  const reviewStatuses = Array.from(reviewStates.entries()).map(([reviewer, state]) => {
                    const discordUsername = discordMentions[reviewer] || `${reviewer}`;
                    const stateAbbreviations = {
                      APPROVED: 'A',
                      CHANGES_REQUESTED: 'RC',
                      COMMENTED: 'C',
                    };
                    const reviewState = stateAbbreviations[state] || state.toLowerCase();
                    return state === 'APPROVED'
                      ? `${discordNotMentions[reviewer]}(${reviewState})` // APPROVEDì¸ ê²½ìš° ë©˜ì…˜ ì—†ì´ ì´ë¦„ë§Œ í‘œì‹œ
                      : `<@${discordMentions[reviewer]}>(${reviewState})`; // ë‚˜ë¨¸ì§€ ìƒíƒœì¸ ê²½ìš° ë©˜ì…˜
                  });

                  // ë¦¬ë·°ë¥¼ ì‹œì‘í•˜ì§€ ì•Šì€ ë¦¬ë·°ì–´ ì¶”ê°€
                  const notStartedReviewers = requestedReviewers.filter(
                    reviewer => !reviewStates.has(reviewer)
                  );
                  console.log(notStartedReviewers, 'ë¦¬ë·°ë¥¼ ì‹œì‘í•˜ì§€ ì•Šì€ ë¦¬ë·°ì–´')
                  
                  const notStartedMentions = notStartedReviewers.map(reviewer => {
                    return `<@${discordMentions[reviewer]}>(X)`;
                  });

                  const reviewStatusMessage = [...reviewStatuses, ...notStartedMentions];

                  console.log(reviewStates, 'í˜„ì¬ ë¦¬ë·° ìƒíƒœ í™•ì¸');
                  console.log(requestedReviewers, 'ìš”ì²­ëœ ë¦¬ë·°ì–´ í™•ì¸');
                  const allReviewersApproved = requestedReviewers.every(
                    reviewer => reviewStates.get(reviewer) === 'APPROVED'
                  );
                  console.log(allReviewersApproved, 'ëª¨ë“  ë¦¬ë·°ì–´ê°€ ì–´í”„ë£¨ë¸Œ ìƒíƒœì¸ê°€?')

                  const noPendingReviews = notStartedReviewers.length === 0;

                  // ëª¨ë“  ë¦¬ë·°ì–´ê°€ APPROVED ìƒíƒœì´ê³  ë¦¬ë·°ë¥¼ ì‹œì‘í•˜ì§€ ì•Šì€ ë¦¬ë·°ì–´ê°€ ì—†ëŠ” ê²½ìš°
                  if (allReviewersApproved && noPendingReviews) {
                    const authorMention = discordMentions[pr.user.login] || `${pr.user.login}`;
                    return `[[${pr.dLabelName}] ${pr.title}](<${pr.html_url}>)\në¦¬ë·°ì–´: ${reviewStatusMessage.join(', ')}\n<@${authorMention}>, ëª¨ë“  ë¦¬ë·°ì–´ì˜ ìŠ¹ì¸ ì™„ë£Œ! ì½”ë©˜íŠ¸ë¥¼ í™•ì¸ í›„ ë¨¸ì§€í•´ ì£¼ì„¸ìš” ğŸš€`;
                  }

                  // ì¼ë°˜ì ì¸ ë¦¬ë§ˆì¸ë“œ ë©”ì‹œì§€
                  return `[[${pr.dLabelName}] ${pr.title}](<${pr.html_url}>)\në¦¬ë·°ì–´: ${reviewStatusMessage.join(', ')}`;
                })
              );

              // ìµœì¢… ë©”ì‹œì§€ Discordì— ì „ì†¡
              const response = await fetch(process.env.DISCORD_WEBHOOK, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    content: `ğŸ€ [FE] ë¦¬ë·°ê°€ í•„ìš”í•œ PR ëª©ë¡ ğŸ€\n\n${messages.join('\n\n')}\n\n`,
                    allowed_mentions: {
                      parse: ["users"], // ë©˜ì…˜ ê°€ëŠ¥í•œ ì‚¬ìš©ìë§Œ í—ˆìš©
                    },
                  }),
                });
                console.log('Response status:', response.status);
            } catch (error) {
              console.error('Error processing FE PR reminders:', error.message);
              throw error; // ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ìƒíƒœ ë°˜í™˜
            }
