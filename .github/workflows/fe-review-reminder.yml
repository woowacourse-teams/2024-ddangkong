name: FE Review Reminder for Discord

on:
  pull_request:
    branches:
      - develop
  schedule:
    - cron: '0 2 * * 1-5' # ë§¤ì£¼ ì›”ìš”ì¼ë¶€í„° ê¸ˆìš”ì¼ê¹Œì§€, í•œêµ­ ì‹œê°„ ì˜¤ì „ 11ì‹œì— ì‹¤í–‰
  workflow_dispatch:

jobs:
  review-reminder:
    runs-on: ubuntu-latest

    steps:
      - name: Send Reminder to Discord
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.FE_REVIEW_NOTIFICATION_WEBHOOK_URL }}
          DISCORD_MENTION: ${{ secrets.FE_GITHUB_DISCORD_ID }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // GitHub ì‚¬ìš©ìëª…ê³¼ ë””ìŠ¤ì½”ë“œ ì•„ì´ë”” ë˜ëŠ” ë‹‰ë„¤ì„ìœ¼ë¡œ ë§¤í•‘
            const discordMentions = JSON.parse(process.env.DISCORD_MENTION);

            const discordNotMentions = {
              'useon': 'ì¬ë°ì´',
              'novice0840': 'í¬ë©”',
              'rbgksqkr': 'ë§ˆë£¨',
            };

            async function getReviews(owner, repo, prNumber) {
              // íŠ¹ì • PRì˜ ë¦¬ë·° ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
              const reviews = await github.rest.pulls.listReviews({
                owner,
                repo,
                pull_number: prNumber,
              });
              return reviews.data;
            }

            try {
              // ì—´ë ¤ ìˆëŠ” PR ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
              const pullRequests = await github.rest.pulls.list({
                owner,
                repo,
                state: 'open',
              });

              // FE ë¼ë²¨ì´ ë‹¬ë¦° PRì„ D-DAYê°€ ì„ë°•í•œ ìˆœì„œë¡œ ì •ë ¬
              const fePrs = pullRequests.data
                .filter(pr => pr.labels.some(label => label.name.includes('FE')))
                .map(pr => {
                  const dLabel = pr.labels.find(label => label.name.startsWith('D-'));
                  const urgency = dLabel ? parseInt(dLabel.name.split('-')[1], 10) : Number.MAX_SAFE_INTEGER;
                  return {
                    ...pr,
                    urgency,
                    dLabelName: dLabel?.name || 'D-unknown',
                    updatedAt: pr.updated_at,
                    createdAt: pr.created_at,
                  };
                })
                .sort((a, b) => a.urgency - b.urgency);

              // ì—´ë¦° PR ì¤‘ FE PRì´ ì—†ëŠ” ê²½ìš° ì‹¤í–‰ ì¢…ë£Œ
              if (fePrs.length === 0) {
                console.log('No FE PRs to remind.');
                return;
              }

              const messages = await Promise.all(
                fePrs.map(async pr => {
                  const reviews = await getReviews(owner, repo, pr.number);
                  const requestedReviewers = pr.requested_reviewers.map(r => r.login);

                  // ìŠ¹ì¸ëœ ë¦¬ë·°ì–´ ëª©ë¡ í™•ì¸
                  const approvedReviewers = reviews.filter(review => review.state === 'APPROVED').map(r => r.user.login);
                  const allApproved = requestedReviewers.every(reviewer => approvedReviewers.includes(reviewer));

                  // ê° ë¦¬ë·°ì–´ì˜ ìƒíƒœ ìƒì„±
                  const reviewStatuses = reviews.map(review => {                    
                    // stateë§ˆë‹¤ ì•½ì ì •ì˜
                    const stateAbbreviations = {
                      APPROVED: 'A',      
                      CHANGES_REQUESTED: 'RC', 
                      COMMENTED: 'C',
                    };

                    // ì•½ìê°€ ì—†ëŠ” ìƒíƒœì¼ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ state ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    const reviewState = stateAbbreviations[review.state] || review.state.toLowerCase();

                    return review.state === 'APPROVED'
                      ? `${discordNotMentions[review.user.login]}(${reviewState})` // APPROVEDì¸ ê²½ìš° ë©˜ì…˜ ì—†ì´ ì´ë¦„ë§Œ í‘œì‹œ
                      : `<@${discordMentions[review.user.login]}>(${reviewState})`; // ë‚˜ë¨¸ì§€ ìƒíƒœì¸ ê²½ìš° ë©˜ì…˜
                  });

                  // ë¦¬ë·°ë¥¼ ì‹œì‘í•˜ì§€ ì•Šì€ ë¦¬ë·°ì–´ ë©˜ì…˜
                  const notStartedReviewers = requestedReviewers.filter(
                    reviewer => !reviews.some(review => review.user.login === reviewer)
                  );

                  const notStartedMentions = notStartedReviewers.map(reviewer => {
                    return `<@${discordMentions[reviewer]}>(X)`;
                  });

                  const reviewStatusMessage = [...reviewStatuses, ...notStartedMentions];

                  // ìƒì„±ì¼ê³¼ ë§ˆì§€ë§‰ ìˆ˜ì •ì¼ í‘œì‹œ
                  const createdDate = new Date(pr.createdAt).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
                  const lastUpdated = new Date(pr.updatedAt).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

                  // ëª¨ë“  ë¦¬ë·°ì–´ê°€ APPROVEDì¸ ê²½ìš°
                  if (allApproved) {
                    const authorMention = discordMentions[pr.user.login] || `${pr.user.login}`;
                    return `[[${pr.dLabelName}] ${pr.title}](${pr.html_url})\në¦¬ë·°ì–´: ${reviewStatusMessage.join(', ')}\n<@${authorMention}>, ëª¨ë“  ë¦¬ë·°ì–´ì˜ ìŠ¹ì¸ ì™„ë£Œ! ì½”ë©˜íŠ¸ë¥¼ í™•ì¸ í›„ ë¨¸ì§€í•´ ì£¼ì„¸ìš” ğŸš€`;
                  }

                  // ì¼ë°˜ì ì¸ ë¦¬ë§ˆì¸ë“œ ë©”ì‹œì§€
                  return `[[${pr.dLabelName}] ${pr.title}](${pr.html_url})\në¦¬ë·°ì–´: ${reviewStatusMessage.join(', ')}`;
                })
              );

              // ìµœì¢… ë©”ì‹œì§€ Discordì— ì „ì†¡
              const response = await fetch(process.env.DISCORD_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  content: `ğŸ€ [FE] ë¦¬ë·°ê°€ í•„ìš”í•œ PR ëª©ë¡ ğŸ€\n\n${messages.join('\n\n')}`,
                  allowed_mentions: {
                    parse: ["users"],
                  },
                }),
              });

              console.log('Response status:', response.status);
            } catch (error) {
              console.error('Error processing FE PR reminders:', error.message);
              throw error; // ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ìƒíƒœ ë°˜í™˜
            }
