name: FE PR D-n ë¼ë²¨ ìˆ˜ì • ìë™í™”

on:
  schedule:
    - cron: "0 15 * * *" # ë§¤ì¼ ë°¤ 12ì‹œ ì‹¤í–‰
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  update-labels:
    runs-on: ubuntu-latest

    steps:
      - name: Update PR Labels with github-script
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // ì—´ë ¤ ìˆëŠ” ëª¨ë“  PRì„ ê°€ì ¸ì˜¨ë‹¤.
            const pullRequests = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
            });

            for (const pr of pullRequests.data) {
              const { number, labels } = pr;

              // ì—´ë ¤ ìˆëŠ” PRì— FE ë¼ë²¨ì´ ë‹¬ë ¤ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
              const hasFeLabel = labels.some(label => label.name === 'ğŸ«§ FE');

              if (!hasFeLabel) {
                console.log(`PR #${number} does not have 'FE' label. Skipping.`);
                continue;
              }

              // 'D-'ë¡œ ì‹œì‘í•˜ëŠ” ë¼ë²¨ì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
              const dLabel = labels.find(label => label.name.startsWith('D-'));

              // 'D-'ë¡œ ì‹œì‘í•˜ëŠ” ë¼ë²¨ì´ ì—†ë‹¤ë©´ D-3' ë¼ë²¨ì„ ì¶”ê°€í•˜ê³  ëë‚¸ë‹¤.
              if (!dLabel) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: number,
                  labels: ['D-3'],
                });
                console.log(`Added 'D-3' label to PR #${number}`);
                continue;
              }

              // 'D-0'ì´ë©´ ì¹´ìš´íŒ…ì„ ìŠ¤í‚µí•œë‹¤.
              if (dLabel.name === 'D-0') {
                console.log(`PR #${number} already at 'D-0'. Skipping decrement.`);
                continue;
              }

              // 'D-n'ë¡œ ì‹œì‘í•˜ëŠ” ë¼ë²¨ì´ ìˆë‹¤ë©´ n ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.
              const currentDay = parseInt(dLabel.name.split('-')[1], 10);

              if (isNaN(currentDay) || currentDay < 1) {
                console.log(`PR #${number} ìœ íš¨í•˜ì§€ ì•Šì€ ë¼ë²¨ì´ê±°ë‚˜ ì—°ì‚°í•  ìˆ˜ ì—†ëŠ” ë¼ë²¨ '${dLabel.name}'.`);
                continue;
              }

              // í˜„ì¬ 'D-n' ë¼ë²¨ì„ ì œê±°í•œë‹¤.
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: number,
                name: dLabel.name,
              });

              // 'D-(n-1)' ë¼ë²¨ì„ ìƒˆë¡œ ì¶”ê°€í•œë‹¤.
              const newDay = currentDay - 1;
              const newLabel = `D-${newDay}`;
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: number,
                labels: [newLabel],
              });

              console.log(`Updated PR #${number}: '${dLabel.name}' -> '${newLabel}'`);
            }
